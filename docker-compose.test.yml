version: '3.8'

# Docker Compose configuration for running test databases
# Used for testing Gassigeher with MySQL and PostgreSQL

services:
  # MySQL 8.0 test database
  mysql-test:
    image: mysql:8.0
    container_name: gassigeher-mysql-test
    environment:
      MYSQL_ROOT_PASSWORD: testpass_root
      MYSQL_DATABASE: gassigeher_test
      MYSQL_USER: gassigeher_test
      MYSQL_PASSWORD: testpass
    ports:
      - "3307:3306"  # Use 3307 to avoid conflict with local MySQL
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ptestpass_root"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
    volumes:
      - mysql_test_data:/var/lib/mysql

  # PostgreSQL 15 test database
  postgres-test:
    image: postgres:15-alpine
    container_name: gassigeher-postgres-test
    environment:
      POSTGRES_DB: gassigeher_test
      POSTGRES_USER: gassigeher_test
      POSTGRES_PASSWORD: testpass
    ports:
      - "5433:5432"  # Use 5433 to avoid conflict with local PostgreSQL
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gassigeher_test -d gassigeher_test"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    volumes:
      - postgres_test_data:/var/lib/postgresql/data

  # Optional: Adminer for database management (web UI)
  adminer:
    image: adminer:latest
    container_name: gassigeher-adminer
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: mysql-test
      ADMINER_DESIGN: nette
    depends_on:
      - mysql-test
      - postgres-test

volumes:
  mysql_test_data:
    driver: local
  postgres_test_data:
    driver: local

# Usage Instructions:
#
# Start all test databases:
#   docker-compose -f docker-compose.test.yml up -d
#
# View logs:
#   docker-compose -f docker-compose.test.yml logs -f
#
# Stop all test databases:
#   docker-compose -f docker-compose.test.yml down
#
# Clean up (remove volumes):
#   docker-compose -f docker-compose.test.yml down -v
#
# Access Adminer UI:
#   http://localhost:8081
#   Server: mysql-test or postgres-test
#   Username: gassigeher_test
#   Password: testpass
#   Database: gassigeher_test
#
# Test Database Connection Strings:
#
# MySQL:
#   DB_TEST_MYSQL="gassigeher_test:testpass@tcp(localhost:3307)/gassigeher_test?parseTime=true&charset=utf8mb4"
#
# PostgreSQL:
#   DB_TEST_POSTGRES="postgres://gassigeher_test:testpass@localhost:5433/gassigeher_test?sslmode=disable"
